{% load static %}
<!DOCTYPE html>
<html>
<head>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/alpinejs/3.13.5/cdn.min.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.2/Sortable.min.js"></script>
    <link rel="stylesheet" type="text/css" href="{% static 'planner/css/tailwind_output.css' %}">
    <script>
    // Initial data with explicit IDs
    const weekdayGroups = {
        monday: {
            id: 'monday',
            name: 'Monday',
            recipeIds: ['overnight-oats', 'greek-yogurt', 'pasta-carbonara']
        },
        tuesday: {
            id: 'tuesday',
            name: 'Tuesday',
            recipeIds: ['chicken-korma', 'quinoa-salad', 'beef-stir-fry']
        },
        wednesday: {
            id: 'wednesday',
            name: 'Wednesday',
            recipeIds: ['smoothie-bowl', 'chicken-sandwich', 'fish-curry']
        },
        // ... add other days
    };

    const mealTypeGroups = {
        breakfast: {
            id: 'breakfast',
            name: 'Breakfast',
            recipeIds: ['overnight-oats', 'greek-yogurt', 'pancakes', 'french-toast']
        },
        lunch: {
            id: 'lunch',
            name: 'Lunch',
            recipeIds: ['quinoa-salad', 'chicken-sandwich', 'lentil-soup']
        },
        // ... add other meal types
    };

    const recipes = {
        'overnight-oats': { id: 'overnight-oats', name: 'Overnight Oats (for 2)' },
        'greek-yogurt': { id: 'greek-yogurt', name: 'Greek Yogurt Bowl (for 1)' },
        'pasta-carbonara': { id: 'pasta-carbonara', name: 'Pasta Carbonara (for 3)' },
        'chicken-korma': { id: 'chicken-korma', name: 'Chicken Korma (for 4)' },
        'quinoa-salad': { id: 'quinoa-salad', name: 'Quinoa Salad (for 4)' },
        'beef-stir-fry': { id: 'beef-stir-fry', name: 'Beef Stir Fry (for 3)' },
        'smoothie-bowl': { id: 'smoothie-bowl', name: 'Smoothie Bowl (for 2)' },
        'chicken-sandwich': { id: 'chicken-sandwich', name: 'Chicken Sandwich (for 2)' },
        'fish-curry': { id: 'fish-curry', name: 'Fish Curry (for 4)' },
        'pancakes': { id: 'pancakes', name: 'Pancakes (for 3)' },
        'french-toast': { id: 'french-toast', name: 'French Toast (for 4)' },
        'lentil-soup': { id: 'lentil-soup', name: 'Lentil Soup (for 6)' }
    };

    document.addEventListener('alpine:init', () => {
        Alpine.data('mealPlan', () => ({
            recipes,
            groups: weekdayGroups,
            
            initSortable() {
                // First destroy any existing instances
                document.querySelectorAll('.recipe-list').forEach(el => {
                    if (el.sortable) {
                        el.sortable.destroy();
                    }
                });
    
                // Create new instances
                document.querySelectorAll('.recipe-list').forEach(el => {
                    const that = this;
                    el.sortable = new Sortable(el, {
                        group: 'recipes',
                        animation: 150,
                        ghostClass: 'bg-blue-50',
                        dragClass: 'opacity-50',
                        onEnd: function(evt) {
                            const recipeId = evt.item.getAttribute('data-recipe-id');
                            const targetGroupId = evt.to.getAttribute('data-group-id');
                            const newPosition = evt.newIndex;
                            
                            that.handleMove(recipeId, targetGroupId, newPosition);
                        }
                    });
                });
            },
    
            handleMove(recipeId, targetGroupId, newPosition) {
                // ... same as before
            },
    
            groupBy(type) {
                this.groups = type === 'weekday' ? weekdayGroups : mealTypeGroups;
                // Reinitialize sortable after view change
                this.$nextTick(() => {
                    this.initSortable();
                });
            },
    
            init() {
                // Initialize sortable after initial render
                this.$nextTick(() => {
                    this.initSortable();
                });
            }
        }));
    });
    </script>
</head>
<body class="bg-slate-50 min-h-screen p-6">
    <div x-data="mealPlan" class="container mx-auto max-w-5xl" x-init="init">
        <div class="mb-8">
            <h1 class="text-3xl font-bold text-gray-900 mb-6">My Meal Plan</h1>
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                <h2 class="text-lg font-semibold text-gray-700 mb-4">Group By</h2>
                <div class="space-x-3">
                    <button @click="groupBy('weekday')" class="px-5 py-2.5 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 font-medium transition-colors">Weekday</button>
                    <button @click="groupBy('mealType')" class="px-5 py-2.5 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 font-medium transition-colors">Meal Type</button>
                </div>
            </div>
        </div>

        <div class="space-y-6">
            <template x-for="group in Object.values(groups)" :key="group.id">
                <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
                    <div class="p-5 border-b border-gray-200 bg-gray-50">
                        <h3 class="text-xl font-semibold text-gray-800" x-text="group.name"></h3>
                    </div>
                    <div class="p-5">
                        <ul class="recipe-list divide-y divide-gray-100" :data-group-id="group.id">
                            <template x-for="(recipeId, index) in group.recipeIds" :key="recipeId">
                                <li class="flex items-center py-3 px-2 hover:bg-gray-50 rounded-md transition-colors cursor-move"
                                    :data-recipe-id="recipeId">
                                    <span class="text-gray-700" x-text="recipes[recipeId].name"></span>
                                </li>
                            </template>
                            <li x-show="group.recipeIds.length === 0" 
                                class="text-gray-500 italic py-3 px-2"
                                data-no-drag>
                                No recipes added yet
                            </li>
                        </ul>
                    </div>
                </div>
            </template>
        </div>

        <div class="mt-8">
            <button class="w-full px-6 py-4 bg-green-600 text-white rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 font-semibold transition-colors">
                Update Shopping List
            </button>
        </div>
    </div>
</body>
</html>